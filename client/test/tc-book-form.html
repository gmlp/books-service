<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <script src="../bower_components/webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../bower_components/web-component-tester/browser.js"></script>
    <script src="../bower_components/test-fixture/test-fixture-mocha.js"></script>

    <link rel="import" href="../bower_components/polymer/polymer.html">
    <link rel="import" href="../bower_components/test-fixture/test-fixture.html">
    <link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
    <link rel="import" href="../bower_components/paper-button/paper-button.html">
    <link rel="import" href="../bower_components/paper-input/paper-input.html">
    <link rel="import" href="../bower_components/paper-input/paper-textarea.html">
    <link rel="import" href="../bower_components/paper-toast/paper-toast.html">

    <link rel="import" href="../components/tc-books/tc-book-form.html">

</head>
<body>

<test-fixture id="fixture">
    <template>
        <tc-book-form></tc-book-form>
    </template>
</test-fixture>

<script>

    describe('tc-book-form', function() {

        var element;

        before(function() {
            element = fixture('fixture');
        });

        describe('_data property', function() {

            it('is defined', function(){
                assert.isDefined(element._data);
                assert.isObject(element._data);
            });
        });

        describe('_id element', function() {

            it('is defined', function(){
                assert.isDefined(element.$._id);
            });

            it('sets label', function(){
                assert.equal(element.$._id.label, 'ID');
            });

            it('binds to _data._id property', function(){
                element._data = {_id: 123};
                assert.equal(element.$._id.value, element._data._id);
            });

            it('sets auto-validate', function(){
                assert.isTrue(element.$._id.autoValidate);
            });

            it('accepts only numbers', function(){
                element.$._id.value = 'asdf';
                assert.isFalse(element.$._id.validate())
            });

            it('does not accept leading 0', function(){
                element.$._id.value = '0123';
                assert.isFalse(element.$._id.validate());
            });

            it('is required', function(){
                element.$._id.value = '';
                assert.isFalse(element.$._id.validate());
            });
            it('sets error message', function(){
                assert.equal(element.$._id.errorMessage, 'Must be a number');
            });
        });
        describe('title element', function(){

            it('is defined', function(){
                assert.isDefined(element.$.title);
            });
            it('set label', function(){
                assert.equal(element.$.title.label, 'Title');
            });
            it('binds to _data.title property', function(){
                element._data = {title: 'some Title'};
                assert.equal(element.$.title.value, element._data.title);
            });
            it('sets auto-validate', function(){
                assert.isTrue(element.$.title.autoValidate);
            });
            it('is required', function(){
                element.$.title.value = '';
                assert.isFalse(element.$.title.validate());
            });
            it('sets error message', function(){
                assert.equal(element.$.title.errorMessage, 'title is required');
            });
        });
        describe('description element', function(){

            it('is defined', function(){
                assert.isDefined(element.$.description)
            });
            it('set label', function(){
                assert.equal(element.$.description.label, 'Description');
            });
            it('binds to _data.description property', function(){
                element._data = {description: 'some description'};
                assert.equal(element.$.description.value, element._data.description);
            });
        });
        describe('requestUrl', function(){

            it('is defined', function(){
                assert.isDefined(element.requestUrl);
                assert.isString(element.requestUrl);
                assert.equal(element.requestUrl, '/api/v1/books');
            });
        });
        describe('putAjax element', function(){

            it('is defined', function(){
                assert.isDefined(element.$.putAjax);
            });
            it('set method to PUT', function(){
                assert.equal(element.$.putAjax.method, 'PUT');
            });
            it('sets content-type', function(){
                assert.equal(element.$.putAjax.contentType, 'application/json');
            });
            it('binds url to requestUrl property', function(){
                element.requestUrl = '/api/my/service'
                assert.equal(element.$.putAjax.url, element.requestUrl);
            });
        });
        describe('form element', function(){

            it('form element', function(){
                assert.isDefined(element.$.form);
            });
        });
        describe('_submit function', function(){

            var el;

            beforeEach(function() {
                el = fixture('fixture');
                el.$.form.checkValidity = sinon.mock().returns(true);
                el.$.putAjax.generateRequest = sinon.mock();
            });

            it('sets _data property to putAjax.body', function() {
                var expected = JSON.stringify({_id: 123, title: "Book Title", description: ""});
                el._data = {_id: "123", title: "Book Title", description: ""};
                el._submit();
                assert.equal(el.$.putAjax.body, expected);
            });

            it('calls putAjax.generateRequest', function() {
                 el._submit();
                 sinon.assert.calledOnce(el.$.putAjax.generateRequest);
            });
            it('calls _handleError when form is invalid', function() {
                 el._handleError = sinon.mock();
                 el.$.form.checkValidity  = sinon.mock().returns(false);
                 el._submit();
                 sinon.assert.calledWith(el._handleError, 'At least one field is invalid.');
            });
        });
    });
</script>

</body>
</html>
